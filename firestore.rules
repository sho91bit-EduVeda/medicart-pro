rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is an admin/owner
    function isAdmin() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['OWNER', 'owner'];
    }
    
    // Categories - Public read, authenticated write
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Products - Public read, authenticated write
    match /products/{productId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Product Reviews - Public read, public create (anonymous reviews allowed)
    match /product_reviews/{reviewId} {
      allow read: if true;
      allow create: if true;  // Allow anyone to submit reviews
      allow update, delete: if isAuthenticated() && resource.data.user_id == request.auth.uid;
    }
    
    // Settings - Public read, authenticated write
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Feature Flags - Public read, authenticated write
    match /feature_flags/{flagId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Announcements - Public read, authenticated write
    match /announcements/{announcementId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Offers - Public read (only enabled), authenticated write
    match /offers/{offerId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Orders - Users can read/write their own orders, admins can read all
    match /orders/{orderId} {
      allow read: if isAuthenticated() && (resource.data.user_id == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.user_id == request.auth.uid;
      allow update, delete: if isAuthenticated() && (resource.data.user_id == request.auth.uid || isAdmin());
    }
    
    // Order Items - Users can only read/write items for their own orders
    match /order_items/{itemId} {
      allow read, write: if isAuthenticated();
    }
    
    // User-specific data
    match /users/{userId} {
      // Allow users to read their own user document
      allow read: if isOwner(userId);
      // Allow authenticated users to create their own user document
      allow create: if isOwner(userId);
      // Allow users to update their own user document
      allow update: if isOwner(userId);
      
      // Cart - Users can only access their own cart
      match /cart/{itemId} {
        allow read, write: if isOwner(userId);
      }
      
      // Wishlist - Users can only access their own wishlist
      match /wishlist/{itemId} {
        allow read, write: if isOwner(userId);
      }
      
      // Prescriptions - Users can only access their own prescriptions
      match /prescriptions/{prescriptionId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // Customers collection - Allow admin users to read/write all customer data, users can read/write their own data
    match /customers/{customerId} {
      allow read, write: if isAuthenticated() && (isOwner(customerId) || isAdmin());
    }
    
    // Prescription Uploads - Users can only read/write their own prescriptions
    match /prescription_uploads/{prescriptionId} {
      allow read: if isAuthenticated() && resource.data.user_id == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.user_id == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.user_id == request.auth.uid;
    }
    
    // Notifications - Users can only read/write their own notifications
    // Exception: Medicine request notifications can be read by any authenticated user
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && (
        resource.data.user_id == request.auth.uid ||
        (resource.data.type == 'medicine_request' && isAuthenticated())
      );
      allow write: if isAuthenticated();
    }
    
    // Search Logs - Public write (for analytics), authenticated read
    match /search_logs/{logId} {
      allow read: if isAuthenticated();
      allow create: if true;
    }
    
    // Unavailable Medicines - Public read and write (for tracking)
    match /unavailable_medicines/{medicineId} {
      allow read: if true;
      allow write: if true;  // Allow anyone to track unavailable medicines
    }
    
    // Medicine Requests - Public create (for anyone to request), authenticated read for owner/admin
    match /medicine_requests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if true;  // Allow anyone to submit requests
      allow update, delete: if isAuthenticated();  // Allow admin/owner to update status
    }
    
    // Store Reviews - Public read, public create, authenticated update/delete
    match /store_reviews/{reviewId} {
      allow read: if true;
      allow create: if true;  // Allow anyone to submit reviews
      allow update, delete: if isAuthenticated();  // Allow admin/owner to moderate reviews
    }
    
    // Daily Sales - Authenticated read/write (owner only)
    match /daily_sales/{saleId} {
      allow read, write: if isAuthenticated();
    }
    
    // Monthly Reports - Authenticated read/write (owner only)
    match /monthly_reports/{reportId} {
      allow read, write: if isAuthenticated();
    }
  }
}